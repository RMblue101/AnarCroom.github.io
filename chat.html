<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ANARCROOM - Sala de Chat</title>
  <link rel="stylesheet" href="anarcroom.css">
</head>
<body>
  <div class="container">
    <div class="anarcho-logo">A</div>
    
    <h1>ANARCROOM</h1>
    <p id="roomLabel" style="text-align: center; color: #ff6b6b; font-weight: 700; letter-spacing: 2px;"></p>
    
    <hr>
    
    <!-- SECÇÃO DE ENTRADA -->
    <div id="joinSection" class="section">
      <h2>Entrar na Sala</h2>
      <div class="form-group">
        <label for="user">Nome do Utilizador:</label>
        <input type="text" id="user" placeholder="Introduz um pseudónimo" autocomplete="off">
      </div>
      <button onclick="entrar()" style="width: 100%;">⊙ Entrar ⊙</button>
    </div>
    
    <!-- SECÇÃO DE CHAT -->
    <div id="chat" style="display: none;">
      <h2 id="userGreeting"></h2>
      
      <hr>
      
      <div id="messages"></div>
      
      <hr>
      
      <div class="form-group">
        <label for="msg">Mensagem:</label>
        <textarea id="msg" placeholder="Escreve a tua mensagem..." autocomplete="off"></textarea>
      </div>
      
      <button onclick="enviar()" style="width: 100%; margin-bottom: 15px;">⊙ Enviar Mensagem ⊙</button>
      
      <div style="text-align: center;">
        <a href="index.html">← Voltar ao Início</a>
      </div>
    </div>
  </div>

  <script>
    // LocalStorage-only chat (no Firebase)
    const params = new URLSearchParams(window.location.search);
    const room = params.get('room') || 'default';
    document.getElementById('roomLabel').textContent = 'Sala: ' + room.toUpperCase();

    let username = '';

    function formatTime(timestamp) {
      return new Date(timestamp).toLocaleTimeString('pt-PT', { 
        hour: '2-digit', 
        minute: '2-digit',
        second: '2-digit'
      });
    }

    function storageKey(r){ return 'anarcroom_msgs_' + r; }

    function loadMessages() {
      const container = document.getElementById('messages');
      container.innerHTML = '';
      const raw = localStorage.getItem(storageKey(room));
      let msgs = [];
      try { msgs = raw ? JSON.parse(raw) : []; } catch(e){ msgs = []; }

      if (!msgs.length) {
        const p = document.createElement('p');
        p.textContent = '(Sem mensagens ainda)';
        p.style.color = '#666';
        p.style.textAlign = 'center';
        p.style.fontStyle = 'italic';
        container.appendChild(p);
        return;
      }

      msgs.sort((a,b)=> a.time - b.time).forEach(m => {
        const p = document.createElement('p');
        const t = formatTime(m.time);
        const user_upper = (m.user||'anon').toUpperCase();
        p.textContent = `[${t}] ${user_upper}: ${m.msg}`;
        container.appendChild(p);
      });
      container.scrollTop = container.scrollHeight;
    }

    window.entrar = function() {
      username = document.getElementById('user').value.trim();
      if (!username) {
        alert('Por favor, introduz um nome de utilizador');
        return;
      }

      document.getElementById('joinSection').style.display = 'none';
      document.getElementById('chat').style.display = 'block';
      document.getElementById('userGreeting').textContent = 'Bem-vindo, ' + username.toUpperCase();
      loadMessages();
      document.getElementById('msg').focus();
    };

    window.enviar = function() {
      const txt = document.getElementById('msg').value.trim();
      if (!txt) return;

      const raw = localStorage.getItem(storageKey(room));
      let msgs = [];
      try { msgs = raw ? JSON.parse(raw) : []; } catch(e){ msgs = []; }

      msgs.push({ user: username, msg: txt, time: Date.now() });
      try { localStorage.setItem(storageKey(room), JSON.stringify(msgs)); } catch(e){ alert('Erro ao gravar localStorage: ' + e.message); }

      document.getElementById('msg').value = '';
      loadMessages();
      document.getElementById('msg').focus();
    };

    // Enviar ao pressionar Ctrl+Enter
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && (e.ctrlKey || e.metaKey) && document.activeElement.id === 'msg') {
        enviar();
      }
    });
  </script>
</body>
</html>
