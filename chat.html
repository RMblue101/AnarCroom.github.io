<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ANARCROOM - Sala de Chat</title>
  <link rel="stylesheet" href="static/anarcroom.css">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js"></script>
</head>
<body>
  <div class="container">
    <div class="anarcho-logo">A</div>
    
    <h1>ANARCROOM</h1>
    <p id="roomLabel" style="text-align: center; color: #ff6b6b; font-weight: 700; letter-spacing: 2px;"></p>
    
    <hr>
    
    <!-- SECÇÃO DE ENTRADA -->
    <div id="joinSection" class="section">
      <h2>Entrar na Sala</h2>
      <div class="form-group">
        <label for="user">Nome do Utilizador:</label>
        <input type="text" id="user" placeholder="Introduz um pseudónimo" autocomplete="off">
      </div>
      <button onclick="entrar()" style="width: 100%;">⊙ Entrar ⊙</button>
    </div>
    
    <!-- SECÇÃO DE CHAT -->
    <div id="chat" style="display: none;">
      <h2 id="userGreeting"></h2>
      
      <hr>
      
      <div id="messages"></div>
      
      <hr>
      
      <div class="form-group">
        <label for="msg">Mensagem:</label>
        <textarea id="msg" placeholder="Escreve a tua mensagem..." autocomplete="off"></textarea>
      </div>
      
      <button onclick="enviar()" style="width: 100%; margin-bottom: 15px;">⊙ Enviar Mensagem ⊙</button>
      
      <div style="text-align: center;">
        <a href="index.html">← Voltar ao Início</a>
      </div>
    </div>
  </div>

  <script src="static/firebase-config.js"></script>
  <script>
    // Firebase Real-time Chat - Professional Version
    const params = new URLSearchParams(window.location.search);
    const room = params.get('room') || 'default';
    document.getElementById('roomLabel').textContent = 'Sala: ' + room.toUpperCase();

    let username = '';
    let database;

    // Inicializar Firebase
    setTimeout(() => {
      try {
        database = firebase.database();
      } catch (e) {
        console.error('Firebase error:', e);
        alert('Erro ao conectar Firebase. Verifique firebase-config.js');
      }
    }, 100);

    function formatTime(timestamp) {
      return new Date(timestamp).toLocaleTimeString('pt-PT', { 
        hour: '2-digit', 
        minute: '2-digit',
        second: '2-digit'
      });
    }

    function loadMessages() {
      if (!database) return;
      const ref = firebase.database().ref('rooms/' + room + '/messages');
      ref.on('value', (snapshot) => {
        const container = document.getElementById('messages');
        container.innerHTML = '';
        
        const msgs = snapshot.val();
        if (!msgs) {
          const p = document.createElement('p');
          p.textContent = '(Sem mensagens ainda)';
          p.style.color = '#666';
          p.style.textAlign = 'center';
          p.style.fontStyle = 'italic';
          container.appendChild(p);
          return;
        }
        
        Object.values(msgs).sort((a, b) => a.time - b.time).forEach(m => {
          const p = document.createElement('p');
          const t = formatTime(m.time);
          const user_upper = m.user.toUpperCase();
          p.textContent = `[${t}] ${user_upper}: ${m.msg}`;
          container.appendChild(p);
        });
        container.scrollTop = container.scrollHeight;
      });
    }

    window.entrar = function() {
      username = document.getElementById('user').value.trim();
      if (!username) {
        alert('Por favor, introduz um nome de utilizador');
        return;
      }
      if (!database) {
        alert('Firebase ainda não ligado. Tenta de novo.');
        return;
      }
      
      document.getElementById('joinSection').style.display = 'none';
      document.getElementById('chat').style.display = 'block';
      document.getElementById('userGreeting').textContent = 'Bem-vindo, ' + username.toUpperCase();
      loadMessages();
      document.getElementById('msg').focus();
    };

    window.enviar = function() {
      if (!database) return alert('Firebase desligado');
      
      const txt = document.getElementById('msg').value.trim();
      if (!txt) return;
      
      const ref = firebase.database().ref('rooms/' + room + '/messages');
      ref.push({
        user: username,
        msg: txt,
        time: Date.now()
      }).catch(err => {
        alert('Erro ao enviar: ' + err.message);
      });
      
      document.getElementById('msg').value = '';
      document.getElementById('msg').focus();
    };

    // Enviar ao pressionar Ctrl+Enter
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && (e.ctrlKey || e.metaKey) && document.activeElement.id === 'msg') {
        enviar();
      }
    });
  </script>
</body>
</html>
